# 💎 獎金規則設置指南

## 🎯 功能說明

現在您可以自定義獎金規則，而不再是硬編碼的固定獎金！

---

## 🚀 如何使用

### 步驟 1：訪問設置頁面

1. **啟動開發服務器**（如果尚未運行）
   ```bash
   cd wilburs-rewardbook
   npm run dev
   ```

2. **訪問首頁**
   ```
   http://localhost:3000
   ```

3. **點擊右上角「⚙️ 獎金設置」按鈕**

---

## ➕ 添加獎金規則

### 步驟：

1. **點擊「➕ 添加新規則」按鈕**

2. **填寫表單**：

   | 欄位 | 說明 | 範例 |
   |-----|------|------|
   | **適用學生** | 選擇「全局」或特定學生 | 🌍 全局（所有學生） |
   | **規則名稱** | 規則的顯示名稱 | 滿分獎勵 |
   | **圖標** | Emoji 圖標 | 💎 |
   | **顏色** | 規則的顏色標記 | #4a9eff |
   | **最低分數** | 分數範圍下限（百分比） | 100 |
   | **最高分數** | 分數範圍上限（百分比） | 100 |
   | **獎金金額** | 獎金數值 | 30 |
   | **優先級** | 數字越高越優先匹配 | 10 |
   | **說明** | 規則描述（選填） | 考試滿分獲得鑽石獎勵 |

3. **點擊「✅ 創建規則」**

---

## 📝 預設推薦規則

### 方法 1：使用界面逐個添加

訪問 `http://localhost:3000/settings`，添加以下規則：

#### 規則 1：💎 滿分獎勵
- 適用學生：全局
- 最低分數：100%
- 最高分數：100%
- 獎金：$30
- 優先級：10

#### 規則 2：🥇 優秀獎勵
- 適用學生：全局
- 最低分數：90%
- 最高分數：99.99%
- 獎金：$10
- 優先級：9

#### 規則 3：⚙️ 良好獎勵
- 適用學生：全局
- 最低分數：80%
- 最高分數：89.99%
- 獎金：$5
- 優先級：8

#### 規則 4：📖 及格獎勵
- 適用學生：全局
- 最低分數：60%
- 最高分數：79.99%
- 獎金：$2
- 優先級：7

---

### 方法 2：使用 SQL 批量添加

在 **Supabase SQL Editor** 執行：

```sql
-- 添加全局獎金規則
INSERT INTO reward_rules (
  student_id,
  rule_name,
  description,
  icon,
  color,
  min_score,
  max_score,
  reward_amount,
  priority,
  is_active
) VALUES
  (NULL, '💎 滿分獎勵', '考試/作業獲得滿分', '💎', '#FFD700', 100, 100, 30, 10, true),
  (NULL, '🥇 優秀獎勵', '分數達到 90-99 分', '🥇', '#C0C0C0', 90, 99.99, 10, 9, true),
  (NULL, '⚙️ 良好獎勵', '分數達到 80-89 分', '⚙️', '#CD7F32', 80, 89.99, 5, 8, true),
  (NULL, '📖 及格獎勵', '分數達到 60-79 分', '📖', '#4a9eff', 60, 79.99, 2, 7, true),
  (NULL, '❌ 不及格', '分數低於 60 分', '❌', '#ff4444', 0, 59.99, 0, 6, true);
```

---

## 🎯 特殊場景

### 場景 1：為特定學生設置不同獎金

例如，小明表現特別好，給他額外獎勵：

```sql
-- 先查看學生 ID
SELECT id, name FROM students;

-- 為小明添加特殊規則
INSERT INTO reward_rules (
  student_id,
  rule_name,
  icon,
  min_score,
  max_score,
  reward_amount,
  priority,
  is_active
) VALUES
  ('小明的UUID', '🌟 超級獎勵', '⭐', 100, 100, 50, 20, true);
```

### 場景 2：考試和作業不同獎金

目前系統不區分評量類型，但您可以：
1. 為不同科目設置不同的學生規則
2. 手動在 Supabase 中調整特定評量的獎金

---

## 🔧 管理規則

### 停用規則
點擊規則卡片上的「❌ 停用」按鈕，規則將不再生效但保留在數據庫中。

### 啟用規則
點擊已停用規則的「✅ 啟用」按鈕。

### 刪除規則
點擊「🗑️ 刪除」按鈕，將永久刪除規則。

---

## 💡 規則匹配邏輯

當學生完成一個評量時：

1. **系統查詢活躍的規則**（`is_active = true`）
2. **過濾規則**：
   - 全局規則（`student_id IS NULL`）
   - 該學生的專屬規則
3. **按優先級排序**（優先級高的先匹配）
4. **尋找第一個匹配的規則**：
   - `min_score ≤ 實際百分比 ≤ max_score`
5. **應用獎金金額**
6. **如果沒有匹配規則**，使用預設硬編碼規則（向後兼容）

---

## 📊 查看數據

### 查看所有規則

```sql
SELECT 
  r.*,
  s.name as student_name
FROM reward_rules r
LEFT JOIN students s ON r.student_id = s.id
ORDER BY priority DESC;
```

### 查看某學生適用的規則

```sql
SELECT *
FROM reward_rules
WHERE (student_id = '學生UUID' OR student_id IS NULL)
  AND is_active = true
ORDER BY priority DESC;
```

---

## 🎓 範例場景

### 場景：小華的數學特別好，給他更高的獎金

1. 前往設置頁面
2. 添加新規則：
   - 適用學生：小華
   - 規則名稱：數學天才獎
   - 最低分數：95%
   - 最高分數：100%
   - 獎金：$50
   - 優先級：15（高於全局規則）

現在，小華的數學考到 95 分以上，會獲得 $50 而不是 $30！

---

## ❓ 常見問題

### Q1: 為什麼我的規則沒有生效？
**答**：檢查以下幾點：
1. 規則是否已啟用（`is_active = true`）
2. 分數範圍是否正確（最低分 ≤ 最高分）
3. 優先級是否足夠高（高優先級規則會優先匹配）
4. 學生 ID 是否正確

### Q2: 全局規則和學生規則哪個優先？
**答**：取決於優先級（`priority`）。優先級高的先匹配，無論是全局還是個人規則。

### Q3: 可以設置負獎金（懲罰）嗎？
**答**：目前獎金金額欄位不支援負數。懲罰可以通過 `transactions` 表中的 `penalty` 類型交易實現。

### Q4: 如何修改現有規則？
**答**：目前只能停用/啟用/刪除。要修改，請刪除後重新創建，或直接在 Supabase Table Editor 中編輯。

---

## 🚀 下一步

- ✅ 設置基本獎金規則
- ✅ 測試添加評量時獎金自動計算
- ⏭️ 可選：為不同學生設置個性化規則
- ⏭️ 可選：創建「懲罰規則」系統

有任何問題隨時詢問！💪

